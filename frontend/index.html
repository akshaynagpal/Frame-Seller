<!DOCTYPE html>
<html lang="en">
<head>
    <title>Frameseller - Buy amazing photos!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script>

        $(document).ready(function () {
            // executes when HTML-Document is loaded and DOM is ready
            var jwttoken = getCookie("jwttoken");
            if (jwttoken) {
                window.location.href = 'catalog.html';
            }
        });

        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function login() {
            username = $("#loginemail");
            password = $("#loginpassword");

            bool1 = check(username);
            bool2 = check(password);

            if (bool1 && bool2) {
                var promise = new Promise(function (success, failure) {
                    parameters = {
                        'username': username.val(),
                        'password': password.val(),
                    };
                    //console.log(parameters);
                    var request = $.post("http://localhost:8000/stripe_demo/api-token-auth/", parameters, function (data) {
                        //console.log(data);
                    })
                        .done(function (data, textStatus, request) {
                            //console.log(data);
                            //console.log(request.getAllResponseHeaders());
                            success(data);
                        })
                        .fail(function (data, textStatus, request) {
                            //console.log(data);
                            //console.log(data.getAllResponseHeaders())
                            failure(data.responseText);
                        })
                });
                promise.then(function (data) {
                    console.log(data);
                    var jwttoken = data["token"];
                    var jwtpayload = jwttoken.split(".")[1];
                    var json = JSON.parse(window.atob(jwtpayload));
                    var exptime = json["exp"];
                    var d = new Date();
                    d.setTime(parseInt(exptime*1000));
                    var expires = "expires=" + d.toUTCString();
                    console.log(expires);
                    document.cookie = "jwttoken=" + jwttoken + ";" + expires + ";path=/";
                    window.location.href = "catalog.html"
                }, function (data) {
                    alert(data);
                });
            }
        }

        function signUp() {
            firstname = $("#sufirstname");
            lastname = $("#sulastname");
            email = $("#suemail");
            password = $("#supassword");
            repeatpassword = $("#surepeatpassword");

            var bool1 = check(firstname);
            var bool2 = check(lastname);
            var bool3 = check(email);
            var bool4 = check(password);
            var bool5 = check(repeatpassword);

            if (bool1 && bool2 && bool3 && bool4 && bool5) {
                var promise = new Promise(function (success, failure) {
                    parameters = {
                        'first_name': firstname.val(),
                        'last_name': lastname.val(),
                        'email': email.val(),
                        'password': password.val()
                    };
                    console.log(parameters);
                    $.ajax({
                        url: 'http://localhost:8000/stripe_demo/signup/',
                        type: 'POST',
                        contentType: "application/json",
                        data: JSON.stringify(parameters),
                        success: function (data) {
                            success(data);
                        },
                        error: function (data) {
                            console.log(data);
                            failure(data);
                        }
                    });
                });

                promise.then(function (data) {
                    alert("User registered successfully. You can now login");
                    clearSignUpForm();
                }, function (data) {
                    var json = JSON.parse(data);
                    alert(json["error"]);
                });
            }
        }

        function clearSignUpForm() {
            $("#sufirstname").val("");
            $("#sulastname").val("");
            $("#suemail").val("");
            $("#supassword").val("");
            $("#surepeatpassword").val("");
        }

        function check(element) {
            var bool;
            console.log(element.val());
            if (element.val() == "") {
                element.addClass("invalid");
                bool = false;
            } else {
                element.removeClass("invalid");
                bool = true;

            }

            if (element.attr('id') == "surepeatpassword" && element.val() !== "") {
                if ($("#supassword").val() !== element.val()) {
                    alert("Passwords do not match");
                    element.addClass("invalid");
                    $("supassword").addClass("invalid");
                }
            }
            return bool
        }
    </script>
    <style>
        input.valid {
            border-color: inherit;
        }

        input.invalid {
            border-color: red;
        }

        input:focus {
            border-color: inherit;
        }

    </style>
</head>
<body>

<div class="jumbotron text-center">
    <h1>FrameSeller - Buy Amazing Photos!</h1>
    <p>Buy amazing photos online!</p>
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-6">
            <div class="well">
                <h3>Existing User?</h3>
                <h2>Login</h2>
                <form>
                    <table>
                        <tr>
                            <td class="form">Email:</td>
                            <td class="form"><input type="email" name="userEmail" id="loginemail"
                                                    onblur="check($('#loginemail'))"></td>
                        </tr>
                        <tr>
                            <td class="form">Password:</td>
                            <td class="form"><input type="password" name="userPassword" id="loginpassword"
                                                    onblur="check($('#loginpassword'))"></td>
                        </tr>
                        <tr>
                            <td colspan="2" class="form" align="center"><input type="button" value="Login"
                                                                               onclick="login()"></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="well">
                <h3>New User?</h3>
                <h2>SignUp</h2>
                <form novalidate class="css-form" action="http://localhost:8000/stripe_demo/signup">
                    <table>
                        <tr>
                            <td class="form">First Name:</td>
                            <td class="form"><input type="text" name="firstname" id="sufirstname"
                                                    onblur="check($('#sufirstname'))" required></td>
                        </tr>
                        <tr>
                            <td class="form">Last Name:</td>
                            <td class="form"><input type="text" name="lastname" id="sulastname"
                                                    onblur="check($('#sulastname'))" required></td>
                        </tr>
                        <tr>
                            <td class="form">Email:</td>
                            <td class="form"><input type="email" name="email" id="suemail"
                                                    onblur="check($('#suemail'))" required></td>
                        </tr>
                        <tr>
                            <td class="form">Password:</td>
                            <td class="form"><input type="password" name="password" id="supassword"
                                                    onblur="check($('#supassword'))" required></td>
                        </tr>
                        <tr>
                            <td class="form">Repeat Password:</td>
                            <td class="form"><input type="password" name="repeatUserPassword" id="surepeatpassword"
                                                    onblur="check($('#surepeatpassword'))" required></td>
                        </tr>
                        <tr>
                            <td colspan="2" align="center" class="form"><input type="button" value="Sign Up"
                                                                               onclick="signUp()"></td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="footer">Copyright 2017 XYZ</div>
</body>
</html>